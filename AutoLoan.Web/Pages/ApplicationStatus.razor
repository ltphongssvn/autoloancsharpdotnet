@inject NavigationManager Nav
@inject AutoLoan.Web.Services.AuthStateService AuthState

<PageTitle>Application Status - Auto Loan</PageTitle>

<div class="status-page">
    <div class="status-header">
        <h2>Application Status</h2>
        <button class="btn-logout" @onclick="OnLogout">Logout</button>
    </div>

    <div class="status-content">
        <h3>Application @AppId</h3>

        <div class="card">
            <div class="steps-bar">
                @for (int i = 0; i < statusSteps.Length; i++)
                {
                    var idx = i;
                    <div class="step-item @(CurrentStepIndex > idx ? "step-done" : CurrentStepIndex == idx ? "step-active" : "")">
                        <div class="step-circle">@(idx + 1)</div>
                        <span class="step-label">@statusSteps[idx]</span>
                    </div>
                }
            </div>
            <div class="status-info-row">
                <div>
                    <span class="text-muted">Current Status</span>
                    <div class="chip chip-@StatusColor">@Status.Replace("_", " ").ToUpper()</div>
                </div>
                <div style="text-align:right">
                    <span class="text-muted">Last Updated</span>
                    <div>@LastUpdated</div>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(StatusDescription))
            {
                <div class="alert-info">@StatusDescription</div>
            }
        </div>

        @if (Status == "pending_documents" && requestedDocs.Count > 0)
        {
            <div class="alert-warning-block">
                <strong>Action Required</strong>
                <p>Additional documents have been requested.</p>
                <div class="btn-row">
                    @foreach (var doc in requestedDocs)
                    {
                        <button class="btn-outline-sm" @onclick="() => UploadDoc(doc.DocType)">Upload @doc.DocType.Replace("_", " ")</button>
                    }
                </div>
            </div>
        }

        <div class="card">
            <h4>Status History</h4>
            <div class="history-list">
                @if (!string.IsNullOrEmpty(SubmittedAt))
                {
                    <div class="history-item"><span class="icon-check">✓</span><div><strong>Submitted</strong><br /><span class="text-muted">@SubmittedAt</span></div></div>
                }
                <div class="history-item"><span class="icon-check">✓</span><div><strong>Draft Created</strong><br /><span class="text-muted">@CreatedAt</span></div></div>
            </div>
        </div>

        <div class="card">
            <h4>Application Details</h4>
            <div class="detail-row"><span class="text-muted">Vehicle</span><span>@Vehicle</span></div>
            <hr />
            <div class="detail-row"><span class="text-muted">Loan Amount</span><span>$@LoanAmountDisplay</span></div>
            <hr />
            <div class="detail-row"><span class="text-muted">Term</span><span>@Term months</span></div>
            <hr />
            <div class="detail-row"><span class="text-muted">Monthly Payment</span><strong>$@MonthlyDisplay</strong></div>
        </div>

        <div class="card">
            <h4>Documents</h4>
            @if (loadingDocs)
            {
                <div class="loading-bar"></div>
            }
            else
            {
                @foreach (var dt in docTypes)
                {
                    var uploaded = uploadedDocs.Contains(dt.Key);
                    <div class="doc-row">
                        <span class="@(uploaded ? "icon-check" : "icon-empty")">@(uploaded ? "✓" : "○")</span>
                        <span>@dt.Label</span>
                        @if (!uploaded)
                        {
                            <button class="btn-sm-upload" @onclick="() => UploadDoc(dt.Key)">Upload</button>
                        }
                    </div>
                }
            }
        </div>

        <button class="btn-outline" @onclick="OnBack">← Back to Dashboard</button>
    </div>
</div>

<style>
    .status-page { min-height: 100vh; background: #f5f5f5; }
    .status-header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .status-header h2 { margin: 0; font-weight: 700; }
    .btn-logout { background: white; border: 1px solid #dc2626; color: #dc2626; padding: 0.4rem 1rem; border-radius: 4px; cursor: pointer; }
    .status-content { max-width: 800px; margin: 0 auto; padding: 2rem 1rem; }
    .status-content h3 { margin-bottom: 1rem; }
    .card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
    .card h4 { margin-bottom: 1rem; font-weight: 600; }
    .steps-bar { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
    .step-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.25rem; }
    .step-active .step-circle { background: #667eea; color: white; }
    .step-done .step-circle { background: #10b981; color: white; }
    .step-label { font-size: 0.75rem; color: #666; }
    .step-active .step-label { color: #667eea; font-weight: 600; }
    .status-info-row { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 1rem; }
    .text-muted { color: #666; font-size: 0.85rem; display: block; }
    .chip { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.8rem; font-weight: 600; margin-top: 0.25rem; }
    .chip-success { background: #dcfce7; color: #16a34a; }
    .chip-error { background: #fef2f2; color: #dc2626; }
    .chip-warning { background: #fffbeb; color: #b45309; }
    .chip-info { background: #eff6ff; color: #2563eb; }
    .chip-secondary { background: #f3e8ff; color: #7c3aed; }
    .chip-default { background: #f3f4f6; color: #374151; }
    .alert-info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; padding: 0.75rem; border-radius: 4px; margin-top: 1rem; font-size: 0.9rem; }
    .alert-warning-block { background: #fffbeb; border: 1px solid #fde68a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
    .alert-warning-block p { margin: 0.5rem 0; font-size: 0.9rem; }
    .btn-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn-outline-sm { background: white; border: 1px solid #ccc; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .history-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .history-item { display: flex; gap: 0.75rem; align-items: flex-start; }
    .icon-check { color: #16a34a; font-weight: bold; font-size: 1.1rem; }
    .icon-empty { color: #ccc; font-size: 1.1rem; }
    .detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; }
    .doc-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; }
    .btn-sm-upload { background: #667eea; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-left: auto; }
    .loading-bar { height: 4px; background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%); background-size: 200%; animation: loading 1.5s infinite; border-radius: 2px; }
    @@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .btn-outline { background: white; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
</style>

@code {
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnLogout { get; set; }

    // Stub data - will be replaced with real API data
    private string Status = "submitted";
    private string AppId = "#APP-0001";
    private string Vehicle = "2024 Toyota Camry";
    private string LoanAmountDisplay = "25,000";
    private int Term = 48;
    private string MonthlyDisplay = "587.13";
    private string SubmittedAt = "";
    private string CreatedAt = DateTime.Now.AddDays(-2).ToShortDateString();
    private string LastUpdated = DateTime.Now.ToString("M/d/yyyy h:mm tt");
    private bool loadingDocs = false;

    private string[] statusSteps = { "Draft", "Submitted", "Pending", "Under Review", "Decision" };

    private int CurrentStepIndex => Status switch
    {
        "draft" => 0, "submitted" => 1, "pending" or "pending_documents" => 2,
        "under_review" => 3, "approved" or "rejected" => 4, _ => 0
    };

    private string StatusColor => Status switch
    {
        "approved" => "success", "rejected" => "error",
        "pending" or "pending_documents" => "warning",
        "submitted" => "info", "under_review" => "secondary", _ => "default"
    };

    private string StatusDescription => Status switch
    {
        "submitted" => "Your application has been submitted and is waiting to be processed.",
        "pending" => "Intake started. Staff is verifying your initial documents.",
        "pending_documents" => "Additional documents are required to continue processing.",
        "under_review" => "Your application is under full underwriting review.",
        "approved" => "Congratulations! Your loan has been approved.",
        "rejected" => "Unfortunately, your application was not approved.",
        _ => ""
    };

    private List<(string DocType, string Label)> requestedDocs = new();
    private HashSet<string> uploadedDocs = new();
    private (string Key, string Label)[] docTypes = {
        ("drivers_license", "Driver's License"),
        ("proof_income", "Proof of Income"),
        ("proof_address", "Proof of Residence")
    };

    private void UploadDoc(string docType)
    {
        // TODO: Wire to file upload API
    }
}
